---
icon: "ğŸ¥"
title: "@supabase/ssrã¨Remixã§Googleèªè¨¼ã‚’è¡Œã†"
date: 2025-01-03T00:00:00
description: "@supabase/ssrã¨Remixã§Googleèªè¨¼ã‚’è¡Œã†"
category: "supabase"
tags:
  - cloudflare
  - remix
  - cloudflare
---
## ã¯ã˜ã‚ã«
@supabase/ssrã‚’ç”¨ã„ã¦ã€SSRã§ã®Supabaseèªè¨¼ãŒå‡ºæ¥ã‚‹ã‚ˆã†ã«ãªã£ãŸãŸã‚ã€è¨­å®šæ‰‹é †ã‚’å‚™å¿˜éŒ²çš„ã«æ®‹ã—ã¾ã™ã€‚  

å‰æã¨ã—ã¦ã€Google Cloudã¨Supabaseã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ä½œæˆæ¸ˆã¿ã®æƒ³å®šã§ã™ã€‚  
ã¾ãŸã€ä»Šå›åˆ©ç”¨ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ä»¥ä¸‹ã®é€šã‚Šã¨ãªã‚Šã€@supabase/ssrã¯ç¾æ™‚ç‚¹ã§Bataã§ã‚ã‚‹ç‚¹ã«ã”æ³¨æ„ãã ã•ã„ã€‚    
| ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
| ---- | ---- |
| @supabase/ssr | 0.5.2 |
| @supabase/supabase-js | 2.47.10 |

GitHubãƒ¬ãƒã‚¸ãƒˆãƒªã¯ã“ã¡ã‚‰ã§ã™ï¼  
<ExLinkCard url="https://github.com/sori883/remix_auth_with_supabasessr" />  

â€»ã“ã®è¨˜äº‹ã¯ä¸‹è¨˜ã‚¹ã‚¯ãƒ©ãƒƒãƒ—ã®å†…å®¹ã‚’ãƒ–ãƒ­ã‚°ã«èµ·ã“ã—ãŸã‚‚ã®ã§ã™ã€‚  
<ExLinkCard url="https://zenn.dev/sorinaji/scraps/53d2ab1a57e3ae" />  


## Remixãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
ä»Šå›ã¯Cloudflareå…¬å¼ã®Remix on Cloudflare Workersã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«å°å…¥ã—ã¦ã„ãã¾ã™ã€‚  
<ExLinkCard url="https://developers.cloudflare.com/workers/frameworks/framework-guides/remix/" />  

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦Remixãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚  

```
pnpm create cloudflare@latest remix-supabasessr --framework=remix --experimental
```

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆå¾Œã€å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ ã—ã¦ãŠãã¾ã™ã€‚  

```
pnpm add @supabase/ssr @supabase/supabase-js
```

ãã—ã¦ã€.dev.varsã«Supabaseã§ä½¿ç”¨ã™ã‚‹ç’°å¢ƒå¤‰æ•°ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚  
Suapabseã®ç’°å¢ƒå¤‰æ•°ã¯Project Setting > APIã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚  

```
SUPABASE_URL=https://<project_id>.supabase.co
SUPABASE_ANON_KEY=your_anon_key
```

## Google Cloudã®è¨­å®š
ä»¥ä¸‹ãƒªãƒ³ã‚¯å…ˆã®æ‰‹é †ã‚’ãªãã‚‹å½¢ã«ãªã‚‹ãŸã‚ã€æœ¬è¨˜äº‹ã§ã¯å¤‰æ›´éƒ¨åˆ†ã ã‘ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚  
<ExLinkCard url="https://supabase.com/docs/guides/auth/social-login/auth-google?queryGroups=environment&environment=server&queryGroups=framework&framework=remix&queryGroups=platform&platform=web#application-code-configuration" />  

### OAuthåŒæ„ç”»é¢ã®è¨­å®š
ã¾ãšã¯[OAuthåŒæ„ç”»é¢](https://console.cloud.google.com/apis/credentials/consent)ã‚’ä½œæˆã—ã¾ã™ã€‚  
OAuthåŒæ„ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€`UserType`ã‚’`å¤–éƒ¨`ã¨ã—ã€ã€Œä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚  
![supabasessr_gcp1](./supabasessr_gcp1.webp)  

ã‚¢ãƒ—ãƒªåã¨ãƒ¦ãƒ¼ã‚¶ã‚µãƒãƒ¼ãƒˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯é©å½“ã«
![supabasessr_gcp2](./supabasessr_gcp2.webp)  

èªè¨¼æ¸ˆã¿ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã—ãŸ`SUPABASE_URL`ã®ãƒ‰ãƒ¡ã‚¤ãƒ³éƒ¨åˆ†ã ã‘ã‚’å…¥åŠ›ã—ã¾ã™ã€‚  
![supabasessr_gcp3](./supabasessr_gcp3.webp)  

æ¬¡ã®ç”»é¢ã§ã¯ã€Œã‚¹ã‚³ãƒ¼ãƒ—ã®è¿½åŠ ã¾ãŸã¯å‰Šé™¤ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã®é€šã‚Šè¿½åŠ ã—ã¾ã™ã€‚  
ä¸‹è¨˜ã‚’è¨­å®šã—ãŸå¾Œã¯å…¨ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ãƒœã‚¿ãƒ³ãƒãƒãƒãƒã§OKã§ã™ã€‚  
![supabasessr_gcp4](./supabasessr_gcp4.webp)  

### OAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã®ä½œæˆ
æ¬¡ã«OAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’ä½œæˆã—ã¾ã™ã€‚  
[èªè¨¼æƒ…å ±](https://console.cloud.google.com/apis/credentials)ç”»é¢ã‹ã‚‰ã€ã€Œèªè¨¼æƒ…å ±ã‚’ä½œæˆã€ã€ŒOAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã€ã®é †ã«ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚  
![supabasessr_gcp5](./supabasessr_gcp5.webp)  

OAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã®ä½œæˆã§ã€ä¸‹è¨˜ç”»åƒã®ã¨ãŠã‚Šè¨­å®šã—ã¾ã™ã€‚  
URIã¯Remixã®è¨­å®šã«å¿œã˜ã¦å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚  
![supabasessr_gcp6](./supabasessr_gcp6.webp)  

æœ€å¾Œã«æ‰¿èªæ¸ˆã¿ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã§ã™ãŒã€Supabaseã‹ã‚‰å–å¾—ã—ãŸå€¤ã‚’å…¥åŠ›ã—ã¾ã™ã€‚  
è¨˜è¼‰å ´æ‰€ã¯ã€ŒAuthenticationã€>ã€ŒAuth Providersã€>ã€ŒGoogleã€ã®ä¸­ã«ã‚ã‚‹ã€ŒCallback URL (for OAuth)ã€ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚  
![supabasessr_gcp7](./supabasessr_gcp7.webp)  

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDä½œæˆãŒå®Œäº†ã™ã‚‹ã¨ã€Œã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã€ã¨ã€Œã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã€ãŒç™ºè¡Œã•ã‚Œã¾ã™ã€‚  
ã“ã‚Œã‚’Supabaseã«è¨­å®šã—ã¦ã„ãã¾ã™ã€‚  
![supabasessr_gcp8](./supabasessr_gcp8.webp)  

## Supabaseã®è¨­å®š
Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã€ŒAuthenticationã€>ã€ŒAuth Providersã€>ã€ŒGoogleã€ã‚’é–‹ãã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚  
ã€ŒSaveã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å¾Œã€GoogleãŒEnableã¨ãªã£ã¦ã„ã‚Œã°è¨­å®šå®Œäº†ã§ã™ã€‚  
![supabasessr_sb1](./supabasessr_sb1.webp)  

## Remixã§Googleèªè¨¼ã‚’ã™ã‚‹
### èªè¨¼å‡¦ç†ã®ä½œæˆ
ã¾ãšã¯ã€Remixã§Supabaseã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®Supabase Clientã‚’ä½œæˆã—ã¾ã™ã€‚  
ã“ã¡ã‚‰ã¯ã€ã»ã¼[Supabaseãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://supabase.com/docs/guides/auth/server-side/creating-a-client?queryGroups=framework&framework=remix&queryGroups=package-manager&package-manager=pnpm&queryGroups=environment&environment=remix-component#create-a-client)ã®ä¾‹ã‚’ãã®ã¾ã¾ä½¿ã£ã¦ã„ã¾ã™ã€‚  

```
export function createSupabaseServerClient(request: Request, c:AppLoadContext) {
  const headers = new Headers();

  const client = createServerClient(
      c.cloudflare.env.SUPABASE_URL,
      c.cloudflare.env.SUPABASE_ANON_KEY,
    {
      cookies: {
        getAll() {
          return parseCookieHeader(request.headers.get("Cookie") ?? "");
        },
        setAll(cookiesToSet) {
          for (const cookie of cookiesToSet) {
            const { name, value, options } = cookie;
            headers.append(
            "Set-Cookie",
            serializeCookieHeader(name, value, options),
            );
          }
        },
      },
      cookieOptions: {
        httpOnly: true,
        secure: true,
      },
  });

  return { 
    client,
    headers,
  };
}
```

æ¬¡ã«Supabase Clientã‚’ä½¿ç”¨ã—ãŸãƒ­ã‚°ã‚¤ãƒ³ã‚„ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚’å®Ÿè£…ã—ã¾ã™ã€‚  
`supabase/supabase.server.ts`ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã¨ãŠã‚Šè¨˜è¼‰ã—ã¾ã™ã€‚  

æ³¨æ„ç‚¹ã¨ã—ã¦`successRedirectPath`ã¯å¾Œè¿°ã™ã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å…ˆã«åˆã‚ã›ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ 

```
export const signInWithGoogle = async (
  request: Request,
  c: AppLoadContext,
  successRedirectPath: string = "http://localhost:5173/auth/callback",
) => {
  const supabase = createSupabaseServerClient(request, c);
  const { data, error } = await supabase.client.auth.signInWithOAuth({
    provider: "google",
    options: {
      redirectTo: successRedirectPath,
    },
  });

  return { 
    ok: !error && data ? true : false,
    data: data,
    error: error && !data ? error.message : "",
    headers: supabase.headers,
  };
};

export const signOut = async (
  request: Request,
  c: AppLoadContext,
  successRedirectPath: string = "/",
) => {
  const supabase = createSupabaseServerClient(request, c);
  const { error } = await supabase.client.auth.signOut();

  return { 
    ok: !error ? true : false,
    data: { url: successRedirectPath }, 
    error: error ? error.message : "",
    headers: supabase.headers,
  };

};

export const getUser = async (
  request: Request,
  c: AppLoadContext,
) => {
  const supabase = createSupabaseServerClient(request, c);

  const {
    data: { session },
  } = await supabase.client.auth.getSession();

  return session?.user ?? null;
};

export const isUserLoggedIn = async (
  request: Request,
  c: AppLoadContext,
) => {
  const supabase = createSupabaseServerClient(request, c);

  const {
    data: { user },
  } = await supabase.client.auth.getUser();

  return !!user;
};
```

### ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®ä½œæˆ
`routes/login.tsx`ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã¨ãŠã‚Šè¨˜è¼‰ã—ã¾ã™ã€‚  
`Loader`ã§ã¯ã€`isUserLoggedIn`ã§ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã‹å¦ã‹ã‚’åˆ¤å®šã—ã€ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã§ã‚ã‚Œã°`/user`ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦ã„ã¾ã™ã€‚  
ã€ŒSign Inã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã™ã‚‹ã¨å®Ÿè¡Œã•ã‚Œã‚‹actionã§ã¯`signInWithGoogle`ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å…ˆã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦ã„ã¾ã™ã€‚  

```
export const loader = async ({ request, context }: LoaderFunctionArgs) => {
  if (await isUserLoggedIn(request, context)) {
    return redirect("/user");
  }
  return null;
};

export const action = async ({ request, context }: ActionFunctionArgs) => {
  const data =  await signInWithGoogle(request, context);
  const parsedData = data;

  return redirect(parsedData.data.url!, { headers: data.headers });
};

export default function SignIn() {
  return (
    <div>
      <Form method="post">
        <button type="submit">Sign In</button>
      </Form>
    </div>
  );
}
```


### ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã®ä½œæˆ
æ¬¡ã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å…ˆã®ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚  
ã“ã“ã§ã¯`routes/auth.callback.tsx`ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã¨ãŠã‚Šè¨˜è¼‰ã—ã¾ã™ã€‚  

```ts
export async function loader({ request, context }: LoaderFunctionArgs) {
  const requestUrl = new URL(request.url);
  const code = requestUrl.searchParams.get("code");
  const next = requestUrl.searchParams.get("next") ?? "/user";
  const { client, headers } = createSupabaseServerClient(request, context);

  if (code) {
    const { error } = await client.auth.exchangeCodeForSession(code);
    if (!error) {
      return redirect(next, { headers });
    }
  }

  // return the user to an error page with instructions
  return redirect("/error", { headers });
}
```

codeã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å¤‰æ›ï¼ˆCookieã«ä¿å­˜ï¼‰ã—ã¦ãŠã‚Šã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯[Supabaseãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://supabase.com/docs/guides/auth/social-login/auth-google)ã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚  

### ãƒ¦ãƒ¼ã‚¶ãƒšãƒ¼ã‚¸ã®ä½œæˆ
ãƒ­ã‚°ã‚¤ãƒ³å…ˆã®ãƒ¦ãƒ¼ã‚¶ãƒšãƒ¼ã‚¸`routes/user.tsx`ã‚’ä½œæˆã—ã¾ã™ã€‚  
`Loader`ã§ã¯ãƒ¦ãƒ¼ã‚¶æƒ…å ±ã‚’å–å¾—ã—ã¤ã¤ã€Actionã§ã¯ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚  

```ts
export const loader = async ({ request, context }: LoaderFunctionArgs) => {
  // ãƒ¦ãƒ¼ã‚¶æƒ…å ±ã‚’å–å¾—ã™ã‚‹
  const user = await getUser(request, context);
  return { user };
};

export const action = async ({ request, context }: ActionFunctionArgs) => {
  const data =  await signOut(request, context);
  return redirect(data.data.url, { headers: data.headers });
};

export default function SignIn() {
  // Loaderã‹ã‚‰ãƒ¦ãƒ¼ã‚¶æƒ…å ±ã‚’å—ã‘å–ã‚Šã€ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’åˆ†å²
  const data = useLoaderData<typeof loader>();
  return (
    <div>
      { data.user ? 
        <div>
          <h1>ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã§ã™ï¼</h1>
          <h2>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³</h2>
          <Form method="post">
            <button type="submit">Sign Out</button>
          </Form>
        </div>
        : <h1>æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚ã€‚</h1> 
      }
    </div>
  );  
}
```

## ã‚ã¨ãŒã
@supabase/ssrã¨Remixã‚’ç”¨ã„ãŸGoogleèªè¨¼ã¯ä»¥ä¸Šã§ã™ã€‚  
ç°¡å˜ã§ã™ãŒã€redirectæ™‚ã¯headersã‚’ä»˜ä¸ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ç‚¹ã«æ³¨æ„ã§ã€ç§ã¯åŠæ—¥ã¯ã¾ã‚Šã¾ã—ãŸã€‚  

ã¾ãŸã€Zennã‚¹ã‚¯ãƒ©ãƒƒãƒ—ã§Remixã‹ã‚‰Honoã«JWTã‚’æŠ•ã’ã¦ãƒ¦ãƒ¼ã‚¶æƒ…å ±ã‚’å–å¾—ã™ã‚‹ç­‰è¡Œã£ã¦ã„ã‚‹ã®ã§ã€ã‚‚ã—ã‚ˆã‘ã‚Œã°ã”å‚ç…§ãã ã•ã„ã€‚  
