---
icon: "ğŸ”¥"
title: "hono-remix-adapterã‚’ä½¿ã£ã¦ã¿ãŸï¼ˆCloudflare Workersï¼‰"
date: 2024-11-24T00:00:00
description: "hono-remix-adapterã‚’ä½¿ã£ã¦Cloudflare Workersã§å‹•ã‹ã™"
category: "Hono"
tags:
  - Cloudflare
---
## æ¦‚è¦
Cloudflare Workersã®Static Assetsã‚„Workers logsã®å¯¾å¿œã«ã‚ˆã‚Šã€Workersã§å‹•ã‹ã—ãŸã„äº‹è±¡ãŒå¢—ãˆã¦ãã¾ã—ãŸã­ï¼ï¼  
<ExLinkCard url="https://developers.cloudflare.com/workers/static-assets/" />
<ExLinkCard url="https://developers.cloudflare.com/workers/observability/logs/workers-logs/" />

ãã—ã¦ç´ æ™´ã‚‰ã—ã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§Workersã¨Pagesä¸¡å¯¾å¿œã®hono-remix-adapterãŒHonoä½œè€…æ§˜ã‚ˆã‚Šä½œæˆã•ã‚Œã¾ã—ãŸï¼ï¼ï¼  
<ExLinkCard url="https://github.com/yusukebe/hono-remix-adapter" />

ã“ã‚Œã«ã‚ˆã‚Šã€Workersã§HonoãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’å‚™ãˆãŸRemixãŒç°¡å˜ã«ä½œã‚Œã¦ã€ãƒ­ã‚°ã‚‚è¨˜éŒ²å‡ºæ¥ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼ï¼  
ä»Šå›ã¯æ—©é€Ÿã€Remix on Honoã‚’å‹•ã‹ã—ã¦ã¿ã¾ã™ã€‚  


## hono-remix-adapterã®å°å…¥
åŸºæœ¬ã¯Readmeã®é€šã‚Šå®Ÿæ–½ã—ã¦ã„ãã¾ã™ã€‚  

æˆæœç‰©ã¯ã“ã¡ã‚‰ã‚’å‚ç…§ãã ã•ã„ï¼ï¼  
[https://github.com/sori883/test-hono-remix-adapter](https://github.com/sori883/test-hono-remix-adapter)  

å¤‰æ›´ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã¯ã“ã¡ã‚‰ã§ã™  
[https://github.com/sori883/test-hono-remix-adapter/commit/ffda9ac899b74e4bd0f0d36a1380e2a7d2adaef8](https://github.com/sori883/test-hono-remix-adapter/commit/ffda9ac899b74e4bd0f0d36a1380e2a7d2adaef8)  

ä»Šå›ã¯ã€Cloudflareå…¬å¼ã®Remix on Cloudflare Workersã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«å°å…¥ã—ã¦ã„ãã¾ã™ã€‚  
ã¾ãšã¯ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚  
```
pnpm create cloudflare@latest my-remix-app --framework=remix --experimental
```

åˆã‚ã›ã¦ã€ä»Šå›ã®ä¸»é¡Œã§ã‚ã‚‹ã€Œhono-remix-adapterã€åŠã³ã€ã€Œhonoã€ã€ã€Œ@hono/vite-dev-serverã€ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚  
```
pnpm add hono-remix-adapter hono @hono/vite-dev-server
```

vite.config.tsã‚’ä»¥ä¸‹ã®é€šã‚Šå¤‰æ›´ã—ã¾ã—ãŸã€‚  
```ts
import { defineConfig } from "vite";
import {
  vitePlugin as remix,
  cloudflareDevProxyVitePlugin,
} from "@remix-run/dev";
import serverAdapter from "hono-remix-adapter/vite"
import adapter from "@hono/vite-dev-server/cloudflare"
import tsconfigPaths from "vite-tsconfig-paths"
import { getLoadContext } from './load-context'

declare module "@remix-run/cloudflare" {
  interface Future {
    v3_singleFetch: true;
  }
}

export default defineConfig({
  plugins: [
    cloudflareDevProxyVitePlugin(),
    remix({
      future: {
        v3_fetcherPersist: true,
        v3_relativeSplatPath: true,
        v3_throwAbortReason: true,
        v3_singleFetch: true,
        v3_lazyRouteDiscovery: true,
      },
    }),
    serverAdapter({
      adapter,
      getLoadContext,
      entry: "server/index.ts",
    }),
    tsconfigPaths(),
  ],
  ssr: {
    resolve: {
      conditions: ["workerd", "worker", "browser"],
    },
  },
  resolve: {
    mainFields: ["browser", "module", "main"],
  },
  build: {
    minify: true,
  },
});

```

ã¾ãŸã€load-context.tsã¯ä»¥ä¸‹ã®é€šã‚Šå¤‰æ›´ã—ã¾ã—ãŸã€‚  
ã“ã“ã®Envã¯`codegen`ã§ä½œæˆã•ã‚ŒãŸ`.dev.vars`ã®å‹ã§ã™ã€‚  
```ts
import type { Context } from "hono";
import type { PlatformProxy } from "wrangler";

type GetLoadContextArgs = {
  request: Request
  context: {
    cloudflare: Omit<PlatformProxy<Env>, "dispose" | "caches" | "cf"> & {
      caches: PlatformProxy<Env>["caches"] | CacheStorage
      cf: Request["cf"]
    }
    hono: {
      context: Context;
    }
  }
}

declare module "@remix-run/cloudflare" {
  interface AppLoadContext extends ReturnType<typeof getLoadContext> {
    // This will merge the result of `getLoadContext` into the `AppLoadContext`
    extra: string
    hono: {
      context: Context;
    }
  }
}

export function getLoadContext({ context }: GetLoadContextArgs) {
  return {
    ...context,
    extra: "stuff",
  };
}
```

æ¬¡ã«ã€server/index.tsã«Hono Appã‚’ä½œæˆã—ã¾ã™ã€‚  
å‹•ä½œç¢ºèªç”¨ã«Powered Byã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã¤ã‘ã¦ãŠãã¾ã™ã€‚   
```ts
// server/index.ts
import { Hono } from "hono"

const app = new Hono<{Bindings: Env}>()

app.use(async (c, next) => {
  await next()
  c.header('X-Powered-By', c.env.EXAMPLE_VARIABLE)
})

export default app
```


æœ€å¾Œã«worker.tsã‚’ä½œæˆã—ã¾ã™ã€‚  
```ts
import handle from 'hono-remix-adapter/cloudflare-workers'
import * as build from './build/server'
import { getLoadContext } from './load-context'
import app from './server'

export default handle(build, app, { getLoadContext })
```

ã¾ãŸã€wrangler.tomlã®mainã«worker.tsã‚’æŒ‡å®šã—ã¦ãŠãã¾ã™ã€‚  
```toml
#:schema node_modules/wrangler/config-schema.json
name = "my-remix-app"
compatibility_date = "2024-11-12"
main = "./worker.ts"
assets = { directory = "./build/client" }

# Workers Logs
# Docs: https://developers.cloudflare.com/workers/observability/logs/workers-logs/
# Configuration: https://developers.cloudflare.com/workers/observability/logs/workers-logs/#enable-workers-logs
[observability]
enabled = true

[vars]
EXAMPLE_VARIABLE = "example_valiable"
```

## å‹•ä½œç¢ºèª
### ãƒ­ãƒ¼ã‚«ãƒ«ã§ç¢ºèªã—ã¦ã¿ã¾ã™
X-Powered-Byãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¦ã€Remixå´ã‚‚ç’°å¢ƒå¤‰æ•°å–ã‚Œã¦ã„ã„æ„Ÿã˜ã§ã™ã­ï½ã€‚  
![ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼](./local_header.webp)

### ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦Workersã§ç¢ºèªã—ã¦ã¿ã¾ã™
ãƒ­ãƒ¼ã‚«ãƒ«ã¨åŒæ§˜ã«X-Powered-Byãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¦ã€Remixå´ã‚‚ç’°å¢ƒå¤‰æ•°å–ã‚Œã¦ã„ã„æ„Ÿã˜ã§ã™ã­ï½ã€‚  
![ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãƒ˜ãƒƒãƒ€ãƒ¼](./deploy_header.webp)

ã¤ã„ã§ã«ãƒ­ã‚°ã‚‚ã¡ã‚ƒã‚“ã¨è¨˜éŒ²ã•ã‚Œã¦ã¾ã™ã­ï½ï½ã€‚  
![Workersã®ãƒ­ã‚°](./deploy_log.webp)


## å®Œèµ°ã®æ„Ÿæƒ³
load-context.tsã¯ã‹ãªã‚Šé›°å›²æ°—ã§å¤‰æ›´ã—ãŸãŸã‚ã€ã‚‚ã£ã¨ã„ã„æ–¹æ³•ãŒã‚ã‚‹å¯èƒ½æ€§å¤§ã§ã™ã€‚  
æŠ˜è§’codegenãŒã‚ã‚‹ã®ã§åˆ©ç”¨ã—ãŸã„ï¼ã¨ãªã£ãŸçµæœä¸Šè¨˜ã®é€šã‚Šã¨ãªã‚Šã¾ã—ãŸã€‚  
ã¾ãŸ`extra: "stuff",`ãŒå¿…è¦ãªç†ç”±ã‚‚ã‚ˆãã‚ã‹ã£ã¦ã¾ã›ã‚“ã€‚ã€‚ã€‚ã€‚èª°ã‹ãŠã—ãˆã¦ãã ã•ã„..  


hono-remix-adapterã®ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚¿ã®æ–¹ãŒæ•™ãˆã¦ãã‚Œã¾ã—ãŸï¼åœ§å€’çš„æ„Ÿè¬ã§ã™  

<Twitter url="https://x.com/const_myself/status/1861056753288597664?s=46" />


ã§ã‚‚ã€Workersã¨PagesãŒåˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹ã®ã¯ã‚ˆã„ã§ã™ã­ï¼  
ãƒ­ã‚°ã‚„Service Bindingsã®å‘¼ã³å‡ºã—ç­‰ã€ã©ã¡ã‚‰ã‹ä¸€æ–¹ã«ã—ã‹å®Ÿè£…ã•ã‚Œã¦ã„ãªã„çŠ¶æ³ãŒç™ºç”Ÿã™ã‚‹ã®ã§ã€ä¹—ã‚Šæ›ãˆã‚‹ã‹ã€‚ã€‚ã¨ãªã£ãŸæ™‚ã®å¯¾å¿œãŒå–ã‚Œã‚‹ã®ã¯å¤§å¤‰ã‚ã‚ŠãŒãŸã„ã§ã™ã­ï¼ï¼ï¼ï¼ˆç‰¹ã«å€‹äººé–‹ç™ºã‚’ã—ã¦ã„ã‚‹æ§˜ãªæ–¹ã¨ã‹ã«ï¼ï¼ï¼‰  
